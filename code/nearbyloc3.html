<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearby Complaints Map</title>

    <!-- Latest Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- Latest Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map {
            height: 80vh;
            width: 100%;
            margin: 0;
            border: 1px solid #ccc;
        }
        
        .info-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .complaint-popup {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .status-acknowledged {
            color: #FFA000;
        }
        
        .status-resolved {
            color: #4CAF50;
        }
        
        .error-message {
            color: red;
            padding: 10px;
            margin: 10px 0;
            background-color: #ffe6e6;
            border-radius: 4px;
        }
        
        .marker-icon {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body>
    <div class="info-container">
        <h1>Nearby Complaints Map</h1>
        <button onclick="getUserLocation()">Show My Location</button>
        <div id="error-container"></div>
    </div>
    <div id="map"></div>

    <script>
        let map;
        let markers = [];
        let complaints = [];

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function initMap() {
            try {
                map = L.map('map').setView([12.8408, 80.1534], 15); // Centered on VIT Chennai area
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
            } catch (error) {
                showError('Error initializing map: ' + error.message);
            }
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;

                        map.setView([userLat, userLng], 15);

                        // Add user marker
                        L.marker([userLat, userLng], {
                                icon: L.divIcon({
                                    className: 'user-location-marker',
                                    html: `<div style="background-color: #2196F3;" class="marker-icon"></div>`
                                })
                            })
                            .addTo(map)
                            .bindPopup('Your Location')
                            .openPopup();
                    },
                    error => {
                        showError('Error getting your location: ' + error.message);
                    }
                );
            } else {
                showError('Geolocation is not supported by your browser');
            }
        }

        function loadComplaintData() {
            Papa.parse('nearbyvit1.csv', {
                header: true,
                download: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showError('Error parsing CSV file: ' + results.errors[0].message);
                        return;
                    }
                    complaints = results.data.filter(complaint =>
                        complaint.Latitude && complaint.Longitude &&
                        !isNaN(parseFloat(complaint.Latitude)) &&
                        !isNaN(parseFloat(complaint.Longitude))
                    );
                    showAllComplaints();
                },
                error: function(error) {
                    showError('Error loading CSV file: ' + error.message);
                }
            });
        }

        function getMarkerColor(status) {
            return status === 'Resolved' ? '#4CAF50' : '#FFA000';
        }

        function showAllComplaints() {
            // Clear existing markers
            markers.forEach(marker => marker.remove());
            markers = [];

            complaints.forEach(complaint => {
                try {
                    const lat = parseFloat(complaint.Latitude);
                    const lng = parseFloat(complaint.Longitude);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        const color = getMarkerColor(complaint.Status);
                        const marker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'complaint-marker',
                                html: `<div style="background-color: ${color};" class="marker-icon"></div>`
                            })
                        }).addTo(map);

                        const popupContent = `
                            <div class="complaint-popup">
                                <strong>Category:</strong> ${complaint.Category || 'N/A'}<br>
                                <strong>Status:</strong> <span class="status-${(complaint.Status || '').toLowerCase()}">${complaint.Status || 'N/A'}</span><br>
                                <strong>Date Reported:</strong> ${complaint.DateReported || 'N/A'}<br>
                                <strong>Location:</strong> ${complaint.Location || 'N/A'}<br>
                            </div>
                        `;

                        marker.bindPopup(popupContent);

                        // Show popup on hover
                        marker.on('mouseover', function() {
                            this.openPopup();
                        });
                        marker.on('mouseout', function() {
                            this.closePopup();
                        });

                        markers.push(marker);
                    }
                } catch (error) {
                    console.error('Error adding marker:', error);
                }
            });
        }

        window.onload = function() {
            initMap();
            loadComplaintData();
        };
    </script>
</body>

</html>