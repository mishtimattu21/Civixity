<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complaint Map</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMKa4KScFT5B0Qf7d25pRYV6DupU-Mm-Y"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>

<body>
    <h1>Complaint Map</h1>
    <div id="map"></div>

    <script>
        // Sample complaint data (replace this with a backend API fetch)
        const complaints = [{
            latitude: 12.8408,
            longitude: 80.1534,
            category: "pothole",
            status: "Resolved"
        }, {
            latitude: 12.8401,
            longitude: 80.1534,
            category: "pothole",
            status: "Acknowledged"
        }, {
            latitude: 12.8408,
            longitude: 80.1532,
            category: "streetlight",
            status: "Acknowledged"
        }, {
            latitude: 12.8409,
            longitude: 80.1535,
            category: "pothole",
            status: "Acknowledged"
        }, ];

        // Haversine formula to calculate distance between two coordinates
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = ((lat2 - lat1) * Math.PI) / 180;
            const dLon = ((lon2 - lon1) * Math.PI) / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos((lat1 * Math.PI) / 180) * Math.cos((lat2 * Math.PI) / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Initialize map
        function initMap() {
            // Get user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };

                    // Initialize map centered at user location
                    const map = new google.maps.Map(document.getElementById("map"), {
                        zoom: 14,
                        center: userLocation,
                    });

                    // Add user marker
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "Your Location",
                        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                    });

                    // Filter complaints within 5km radius
                    const nearbyComplaints = complaints.filter((complaint) =>
                        haversine(
                            userLocation.lat,
                            userLocation.lng,
                            complaint.latitude,
                            complaint.longitude
                        ) <= 5
                    );

                    // Add complaint markers
                    nearbyComplaints.forEach((complaint) => {
                        const marker = new google.maps.Marker({
                            position: {
                                lat: complaint.latitude,
                                lng: complaint.longitude
                            },
                            map: map,
                            title: complaint.category,
                        });

                        // Add info window on hover
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<p>Category: ${complaint.category}</p><p>Status: ${complaint.status}</p>`,
                        });

                        marker.addListener("mouseover", () => {
                            infoWindow.open(map, marker);
                        });

                        marker.addListener("mouseout", () => {
                            infoWindow.close();
                        });
                    });
                });
            } else {
                alert("Geolocation is not supported by your browser.");
            }
        }

        // Load the map
        window.onload = initMap;
    </script>
</body>

</html>