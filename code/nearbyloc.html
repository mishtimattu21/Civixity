<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearby Complaints Map</title>

    <!-- Latest Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- Latest Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map {
            height: 80vh;
            width: 100%;
            margin: 0;
            border: 1px solid #ccc;
        }
        
        .info-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .complaint-popup {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .status-open,
        .status-acknowledged {
            color: #d9534f;
        }
        
        .status-resolved {
            color: #5cb85c;
        }
        
        .error-message {
            color: red;
            padding: 10px;
            margin: 10px 0;
            background-color: #ffe6e6;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="info-container">
        <h1>Nearby Complaints Map</h1>
        <button onclick="getUserLocation()">Show Complaints Near Me</button>
        <div id="error-container"></div>
    </div>
    <div id="map"></div>

    <script>
        let map;
        let markers = [];
        let complaints = [];

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function initMap() {
            try {
                map = L.map('map').setView([12.8408, 80.1534], 15); // Centered on VIT Chennai
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
            } catch (error) {
                showError('Error initializing map: ' + error.message);
            }
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;

                        map.setView([userLat, userLng], 15);

                        // Add user marker with different icon
                        L.marker([userLat, userLng], {
                                icon: L.divIcon({
                                    className: 'user-location-marker',
                                    html: `<div style="background-color: #2196F3; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>`
                                })
                            })
                            .addTo(map)
                            .bindPopup('Your Location')
                            .openPopup();

                        showNearbyComplaints(userLat, userLng);
                    },
                    error => {
                        showError('Error getting your location: ' + error.message);
                    }
                );
            } else {
                showError('Geolocation is not supported by your browser');
            }
        }

        function loadComplaintData() {
            Papa.parse('nearbyvit1.csv', {
                header: true,
                download: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showError('Error parsing CSV file: ' + results.errors[0].message);
                        return;
                    }
                    complaints = results.data.filter(complaint =>
                        complaint.latitude && complaint.longitude &&
                        !isNaN(parseFloat(complaint.latitude)) &&
                        !isNaN(parseFloat(complaint.longitude))
                    );
                    showAllComplaints();
                },
                error: function(error) {
                    showError('Error loading CSV file: ' + error.message);
                }
            });
        }

        function showAllComplaints() {
            // Clear existing markers
            markers.forEach(marker => marker.remove());
            markers = [];

            complaints.forEach(complaint => {
                try {
                    const lat = parseFloat(complaint.latitude);
                    const lng = parseFloat(complaint.longitude);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng]).addTo(map);

                        const popupContent = `
                            <div class="complaint-popup">
                                <strong>Category:</strong> ${complaint.category || 'N/A'}<br>
                                <strong>Status:</strong> <span class="status-${(complaint.status || '').toLowerCase()}">${complaint.status || 'N/A'}</span><br>
                                <strong>Date Reported:</strong> ${complaint.datereported || 'N/A'}<br>
                                <strong>Location:</strong> ${complaint.location || 'N/A'}<br>
                            </div>
                        `;

                        marker.bindPopup(popupContent);
                        markers.push(marker);
                    }
                } catch (error) {
                    console.error('Error adding marker:', error);
                }
            });
        }

        function showNearbyComplaints(userLat, userLng) {
            const radius = 5; // 5 km radius

            // Clear existing markers
            markers.forEach(marker => marker.remove());
            markers = [];

            complaints.forEach(complaint => {
                try {
                    const lat = parseFloat(complaint.latitude);
                    const lng = parseFloat(complaint.longitude);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        const distance = getDistance(userLat, userLng, lat, lng);

                        if (distance <= radius) {
                            const marker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'nearby-complaint-marker',
                                    html: `<div style="background-color: #ff4444; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;"></div>`
                                })
                            }).addTo(map);

                            const popupContent = `
                                <div class="complaint-popup">
                                    <strong>Category:</strong> ${complaint.category || 'N/A'}<br>
                                    <strong>Status:</strong> <span class="status-${(complaint.status || '').toLowerCase()}">${complaint.status || 'N/A'}</span><br>
                                    <strong>Date Reported:</strong> ${complaint.datereported || 'N/A'}<br>
                                    <strong>Location:</strong> ${complaint.location || 'N/A'}<br>
                                    <strong>Distance:</strong> ${distance.toFixed(2)} km
                                </div>
                            `;

                            marker.bindPopup(popupContent);
                            markers.push(marker);
                        }
                    }
                } catch (error) {
                    console.error('Error adding nearby marker:', error);
                }
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        window.onload = function() {
            initMap();
            loadComplaintData();
        };
    </script>
</body>

</html>